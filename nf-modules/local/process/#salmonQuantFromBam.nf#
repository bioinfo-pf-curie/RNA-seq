/*
 * Salmon quant from BAM file
 */

process salmonQuantFromBam {
    tag "$prefix"
    label "salmon"
    label "medCpu"
    label "medMem"

    publishDir "${params.outDir}/counts", mode: 'copy'

    input:
    tuple val(prefix), path(bam), val(strandness)
    path(transcriptsFasta)
    path(gtf)

    output:
    tuple val("${prefix}"), path("${prefix}")
    path("versions.txt"), emit: versions

    script:
    strandOpts = params.singleEnd ? 'U' : 'IU'
    if (strandness == 'forward') {
      strandOpts = params.single_end ? 'SF' : 'ISF'
    } else if (strandness == 'reverse') {
      strandOpts = params.single_end ? 'SR' : 'ISR'
    }
    
    """
    salmon quant \\
      -a ${bam} \\
      --threads $task.cpus \\
      -t ${transcriptsFasta} \\
      --geneMap ${gtf} \\
      --libType=$strandOpts \\
      ${salmonQuantOpts} \\
      -o ${prefix}
    """
}
